---
import type { CodeLanguage } from 'astro';
import { Code } from 'astro:components';
import { Copy } from 'lucide-react';

interface Props {
  code: string;
  lang?: CodeLanguage;
  id?: string;
}

const { code, lang = 'text', id } = Astro.props;
---

<div class="code-block-wrapper" id={id}>
  <div class="code-header">
    <span class="code-language">
      {lang}
    </span>
    <button class="copy-btn" aria-label="Copy code" data-code={code}>
      <div class="copy-btn-icon">
        <Copy className="copy-icon" />
      </div>
    </button>
  </div>
  <div class="code-content">
    <div class="code-theme code-theme--light">
      <Code code={code} lang={lang} theme="github-light" wrap={false} />
    </div>
    <div class="code-theme code-theme--dark">
      <Code code={code} lang={lang} theme="github-dark" wrap={false} />
    </div>
  </div>
</div>

<script>
  function setupCopyButtons() {
    const buttons = document.querySelectorAll('.copy-btn');

    buttons.forEach((btn) => {
      // Remove old listener if present (in case of re-runs)
      const newBtn = btn.cloneNode(true) as HTMLButtonElement;
      btn.parentNode?.replaceChild(newBtn, btn);

      newBtn.addEventListener('click', async () => {
        const code = newBtn.getAttribute('data-code') || '';

        try {
          await navigator.clipboard.writeText(code);
        } catch (err) {
          console.error('Failed to copy code:', err);
        }
      });
    });
  }

  // Run on initial load
  setupCopyButtons();

  // Run on view transitions navigation
  document.addEventListener('astro:page-load', setupCopyButtons);
</script>
